name: Frontend Tests

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  unit-tests:
    name: Unit Tests (Jest)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Jest tests
        run: npm test -- --ci --coverage --maxWorkers=2
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend-unit
          name: frontend-unit-tests
  
  integration-tests:
    name: Integration Tests (DiffExplorer)
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Integration Tests
        run: npm test -- --testPathPattern="integration" --ci --maxWorkers=2
  
  regression-check:
    name: Explorer v2 Regression Check
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    
    defaults:
      run:
        working-directory: frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Explorer v2 Regression Tests
        run: |
          npm test -- --testPathPattern="DiffExplorer.integration" --ci
          npx playwright test e2e/explorer-v2.spec.ts
      
      - name: Verify Explorer v2 Never Blocks
        run: |
          echo "✅ Explorer v2 regression tests passed"
          echo "✅ Explorer v2 is NOT blocked when comparison data exists"
          echo "✅ Both Classic and Explorer v2 use the same data source"
