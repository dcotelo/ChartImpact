name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
permissions:
  contents: read
  packages: write
jobs:
  # Detect which components changed since last release
  detect-changes:
    name: Detect Component Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.check.outputs.backend }}
      frontend: ${{ steps.check.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare with previous tag
      
      - name: Detect changes since last release
        id: check
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # First release or no previous tag, build everything
            echo "No previous tag found, building all components"
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "Comparing $PREVIOUS_TAG to $CURRENT_TAG"
            
            # Check for backend changes
            BACKEND_CHANGES=$(git diff --name-only ${PREVIOUS_TAG}..${CURRENT_TAG} | grep -E "^backend/" || true)
            if [ -n "$BACKEND_CHANGES" ]; then
              echo "Backend changes detected:"
              echo "$BACKEND_CHANGES"
              echo "backend=true" >> $GITHUB_OUTPUT
            else
              echo "No backend changes detected"
              echo "backend=false" >> $GITHUB_OUTPUT
            fi
            
            # Check for frontend changes
            FRONTEND_CHANGES=$(git diff --name-only ${PREVIOUS_TAG}..${CURRENT_TAG} | grep -E "^frontend/" || true)
            if [ -n "$FRONTEND_CHANGES" ]; then
              echo "Frontend changes detected:"
              echo "$FRONTEND_CHANGES"
              echo "frontend=true" >> $GITHUB_OUTPUT
            else
              echo "No frontend changes detected"
              echo "frontend=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Summary
        run: |
          echo "### Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed | Action |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ steps.check.outputs.backend }} | ${{ steps.check.outputs.backend == 'true' && 'ðŸš€ Will build & release' || 'â­ï¸ Will skip' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.check.outputs.frontend }} | ${{ steps.check.outputs.frontend == 'true' && 'ðŸš€ Will build & release' || 'â­ï¸ Will skip' }} |" >> $GITHUB_STEP_SUMMARY

  # Test backend before release
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache-dependency-path: backend/go.sum

      - name: Run Go tests
        working-directory: ./backend
        run: go test -v -race -coverprofile=coverage.txt ./...

      - name: Go vet
        working-directory: ./backend
        run: go vet ./...

  # Test frontend before release
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run tests
        working-directory: ./frontend
        run: npm test

      - name: Lint
        working-directory: ./frontend
        run: npm run lint

  # Build backend binary
  build-backend:
    name: Build Backend Binary
    runs-on: ubuntu-latest
    needs: [detect-changes, test-backend]
    if: |
      always() &&
      needs.detect-changes.outputs.backend == 'true' &&
      (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Build Linux AMD64
        working-directory: ./backend
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-s -w -X main.version=${{ github.ref_name }}" \
            -o chartimpact-backend-linux-amd64 ./cmd/server

      - name: Build Linux ARM64
        working-directory: ./backend
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build \
            -ldflags="-s -w -X main.version=${{ github.ref_name }}" \
            -o chartimpact-backend-linux-arm64 ./cmd/server

      - name: Upload backend binaries
        uses: actions/upload-artifact@v4
        with:
          name: backend-binaries
          path: |
            backend/chartimpact-backend-linux-amd64
            backend/chartimpact-backend-linux-arm64

  # Build frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [detect-changes, test-frontend]
    if: |
      always() &&
      needs.detect-changes.outputs.frontend == 'true' &&
      (needs.test-frontend.result == 'success' || needs.test-frontend.result == 'skipped')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build application
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: /api

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/.next

  # Build and push Docker images
  docker-release:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: [detect-changes, build-backend, build-frontend]
    if: |
      always() &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for backend
        if: needs.detect-changes.outputs.backend == 'true'
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push backend image
        if: needs.detect-changes.outputs.backend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip backend image (no changes)
        if: needs.detect-changes.outputs.backend == 'false'
        run: |
          echo "â­ï¸ Skipping backend image build - no changes detected since last release"
          echo "Backend remains at version ${{ github.ref_name }} (unchanged from previous release)"

      - name: Extract metadata for frontend
        if: needs.detect-changes.outputs.frontend == 'true'
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push frontend image
        if: needs.detect-changes.outputs.frontend == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip frontend image (no changes)
        if: needs.detect-changes.outputs.frontend == 'false'
        run: |
          echo "â­ï¸ Skipping frontend image build - no changes detected since last release"
          echo "Frontend remains at version ${{ github.ref_name }} (unchanged from previous release)"
      
      - name: Release Summary
        run: |
          echo "### Docker Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.detect-changes.outputs.backend == 'true' && 'âœ… Built & Released' || 'â­ï¸ Skipped (unchanged)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.detect-changes.outputs.frontend == 'true' && 'âœ… Built & Released' || 'â­ï¸ Skipped (unchanged)' }} |" >> $GITHUB_STEP_SUMMARY

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [detect-changes, build-backend, build-frontend, docker-release]
    if: |
      always() &&
      needs.docker-release.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download backend binaries
        if: needs.detect-changes.outputs.backend == 'true'
        uses: actions/download-artifact@v4
        with:
          name: backend-binaries
          path: ./binaries

      - name: Generate release notes
        id: notes
        run: |
          {
            echo "release_notes<<EOF"
            echo "## Release ${{ github.ref_name }}"
            echo ""
            echo "### Components Released"
            echo ""
            if [ "${{ needs.detect-changes.outputs.backend }}" == "true" ]; then
              echo "- âœ… **Backend**: Updated to ${{ github.ref_name }}"
            else
              echo "- â­ï¸ **Backend**: No changes (remains at ${{ github.ref_name }})"
            fi
            if [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]; then
              echo "- âœ… **Frontend**: Updated to ${{ github.ref_name }}"
            else
              echo "- â­ï¸ **Frontend**: No changes (remains at ${{ github.ref_name }})"
            fi
            echo ""
            echo "### Docker Images"
            echo ""
            if [ "${{ needs.detect-changes.outputs.backend }}" == "true" ]; then
              echo "- \`ghcr.io/${{ github.repository }}/backend:${{ github.ref_name }}\`"
            fi
            if [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]; then
              echo "- \`ghcr.io/${{ github.repository }}/frontend:${{ github.ref_name }}\`"
            fi
            echo ""
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          body: ${{ steps.notes.outputs.release_notes }}
          files: |
            binaries/chartimpact-backend-linux-amd64
            binaries/chartimpact-backend-linux-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

